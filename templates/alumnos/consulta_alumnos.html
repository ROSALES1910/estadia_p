{% extends "layout/base.html" %}

{% block titulo %}Consulta de alumnos{% endblock %}

{% block menu %}
  {% include "layout/menu_general.html" %}
{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/formularios.css') }}">

<main class="dashboard-main">
  <div class="dashboard-body">

    <h2 class="titulo-alineado">Consulta de alumnos</h2>

    <!-- ============================
         BUSCADOR
         ============================ -->
    <div id="buscador">
      <label for="inputBuscar">Buscar alumno:</label>
      <input type="text" id="inputBuscar" placeholder="Nombre, apellido o matr√≠cula">
    </div>

    <!-- ============================
         TABLA DE RESULTADOS
         ============================ -->
    <table id="tablaResultados">
      <thead>
        <tr>
          <th>Matr√≠cula</th>
          <th>Nombre</th>
          <th>Seleccionar</th>
        </tr>
      </thead>
      <tbody id="tbodyResultados"></tbody>
    </table>

    <!-- ============================
         FORMULARIO DEL ALUMNO
         ============================ -->
    <div id="formularioAlumno" class="formulario">

      <fieldset>
        <legend>Datos del alumno</legend>

        <label>Nombre:</label>
        <input type="text" id="nombre" placeholder="Nombre" readonly>

        <label>Apellido paterno:</label>
        <input type="text" id="apellido_paterno" placeholder="Apellido paterno" readonly>

        <label>Apellido materno:</label>
        <input type="text" id="apellido_materno" placeholder="Apellido materno" readonly>

        <label>Tel√©fono:</label>
        <input type="text" id="telefono" placeholder="Tel√©fono" readonly>

        <label>Correo:</label>
        <input type="email" id="email" placeholder="Correo electr√≥nico" readonly>
      </fieldset>

      <div class="form-actions">
        <button type="button" id="editar" class="btn btn-primary">Editar datos</button>
        <a href="/dashboard" class="btn-regresar">Regresar</a>
      </div>

    </div>

  </div>
</main>

<!-- ============================
     PANEL DESLIZABLE
     ============================ -->
<div class="panel-acciones" id="panelAcciones">
  <span class="panel-close" onclick="cerrarPanel()">√ó</span>
  <div class="panel-header">Acciones disponibles</div>

  <ul>
    <li><button onclick="redirigir('modificar_datos_alumno')">‚úèÔ∏è Modificar datos</button></li>
    <li><button onclick="redirigir('asignar_cambiar_proyecto')">üìÇ Asignar/Cambiar proyecto</button></li>
    <li><button onclick="redirigir('asignar_horario')">üìÖ Asignar/Cambiar horario</button></li>
    <li><button onclick="redirigir('comentarios_alumno')">üí¨ Ver comentarios</button></li>
    <li><button onclick="redirigir('log_alumno')">üìú Ver log</button></li>
    <li><button class="btn-eliminar" onclick="redirigir('eliminar')">üóëÔ∏è Eliminar alumno</button></li>
  </ul>
</div>

<div class="overlay" id="overlay" onclick="cerrarPanel()"></div>

<script>
let matriculaSeleccionada = null;

/* ============================
   BUSCADOR EN TIEMPO REAL
   ============================ */
document.getElementById("inputBuscar").addEventListener("input", async () => {
  const q = document.getElementById("inputBuscar").value.trim();

  if (!q) {
    document.getElementById("tablaResultados").style.display = "none";
    return;
  }

  const res = await fetch(`/api/alumnos/buscar?q=${encodeURIComponent(q)}`);
  const alumnos = await res.json();

  const tbody = document.getElementById("tbodyResultados");
  tbody.innerHTML = "";

  alumnos.forEach(a => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${a.matricula}</td>
      <td>${a.nombre} ${a.apellido_paterno} ${a.apellido_materno}</td>
      <td><button onclick="seleccionarAlumno('${a.matricula}')">Seleccionar</button></td>
    `;

    tbody.appendChild(tr);
  });

  document.getElementById("tablaResultados").style.display = alumnos.length ? "table" : "none";
});

/* ============================
   SELECCIONAR ALUMNO
   ============================ */
async function seleccionarAlumno(matricula) {
  matriculaSeleccionada = matricula;

  const res = await fetch(`/api/alumnos/datos?matricula=${encodeURIComponent(matricula)}`);
  const datos = await res.json();

  document.getElementById("nombre").value = datos.nombre || "";
  document.getElementById("apellido_paterno").value = datos.apellido_paterno || "";
  document.getElementById("apellido_materno").value = datos.apellido_materno || "";
  document.getElementById("telefono").value = datos.telefono || "";
  document.getElementById("email").value = datos.email || datos.e_mail || "";

  document.getElementById("formularioAlumno").style.display = "block";
}

/* ============================
   PANEL DE ACCIONES
   ============================ */
document.getElementById("editar").addEventListener("click", () => {
  if (!matriculaSeleccionada) {
    alert("Selecciona primero un alumno.");
    return;
  }
  abrirPanel();
});

function abrirPanel() {
  document.getElementById("panelAcciones").classList.add("activo");
  document.getElementById("overlay").classList.add("activo");
}

function cerrarPanel() {
  document.getElementById("panelAcciones").classList.remove("activo");
  document.getElementById("overlay").classList.remove("activo");
}

/* ============================
   REDIRECCI√ìN CON MATR√çCULA
   ============================ */
function redirigir(accion) {
  window.location.href = `/alumnos/${accion}?matricula=${encodeURIComponent(matriculaSeleccionada)}`;
}
</script>

{% endblock %}