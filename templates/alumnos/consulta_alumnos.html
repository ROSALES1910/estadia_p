{% extends "layout/base.html" %}

{% block contenido %}
<div class="dashboard-wrapper">
  <!-- Menú lateral -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-alumnos')">Alumnos</a>
        <ul class="submenu" id="submenu-alumnos" hidden>
          <li><a href="/alumnos/registrar">Registrar nuevo alumno</a></li>
          <li><a href="/alumnos/activar">Activar/Inactivar alumno</a></li>
          <li><a href="/alumnos/modificar">Modificar datos del alumno</a></li>
          <li><a href="/alumnos/asignar_proyecto">Asignar/Cambiar proyecto al alumno</a></li>
          <li><a href="/alumnos/desasignar_proyecto">Desasignar proyecto al alumno</a></li>
          <li><a href="/alumnos/modificar_contrasena">Cambiar contraseña al alumno</a></li>
          <li><a href="/alumnos/asignar_horario">Asignar/Cambiar horario al alumno</a></li>
          <li><a href="/alumnos/horario">Horario alumno</a></li>
          <li><a href="/alumnos/comentarios">Histórico de comentarios del alumno</a></li>
          <li><a href="/alumnos/log">Log del alumno</a></li>
          <li><a href="/alumnos/eliminar">Eliminar alumno</a></li>
          <li><a href="/alumnos/consulta" class="activo">Consulta de alumnos</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- Área principal -->
  <main class="dashboard-main">
    <div class="dashboard-body">
      <h2>Consulta de alumnos</h2>

      <form class="formulario-alumno">
        <fieldset>
          <legend>Seleccionar alumno</legend>
          <label for="matricula">Alumno:</label>
          <select name="matricula" id="matricula" required>
            <option value="">-- Selecciona un alumno --</option>
            {% for a in alumnos %}
              <option value="{{ a.matricula }}">
                {{ a.nombre }} {{ a.apellido_paterno }} {{ a.apellido_materno }} ({{ a.matricula }})
              </option>
            {% endfor %}
          </select>
        </fieldset>

        <!-- Recuadro profesional de datos del alumno -->
        <fieldset class="datos-alumno">
          <legend>Datos del alumno</legend>

          <div class="datos-grid">
            <!-- Información personal -->
            <div class="grupo">
              <h4>Información personal</h4>

              <label for="nombre">Nombre:</label>
              <input type="text" id="nombre" readonly>

              <label for="apellido_paterno">Apellido paterno:</label>
              <input type="text" id="apellido_paterno" readonly>

              <label for="apellido_materno">Apellido materno:</label>
              <input type="text" id="apellido_materno" readonly>

              <label for="telefono">Teléfono:</label>
              <input type="text" id="telefono" readonly>

              <label for="email">Correo:</label>
              <input type="email" id="email" readonly>
            </div>

            <!-- Información académica -->
            <div class="grupo">
              <h4>Información académica</h4>

              <label for="proyecto">Proyecto:</label>
              <select id="proyecto" disabled>
                {% for proyecto in proyectos %}
                  <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                {% endfor %}
              </select>

              <label for="institucion">Institución:</label>
              <select id="institucion" disabled>
                {% for institucion in instituciones %}
                  <option value="{{ institucion.id }}">{{ institucion.nombre }}</option>
                {% endfor %}
              </select>

              <label for="estado">Estado:</label>
              <select id="estado" disabled>
                {% for e in estados %}
                  <option value="{{ e }}">{{ e }}</option>
                {% endfor %}
              </select>

              <label for="documentacion">Documentación:</label>
              <select id="documentacion" disabled>
                {% for doc in documentacion %}
                  <option value="{{ doc }}">{{ doc }}</option>
                {% endfor %}
              </select>

              <label for="area">Área:</label>
              <select id="area" disabled>
                {% for a in areas %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>

              <label for="tipo_servicio">Tipo de servicio:</label>
              <select id="tipo_servicio" disabled>
                {% for tipo in tipos_servicio %}
                  <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </fieldset>

        <div class="form-actions">
          <button type="button" id="editar">Editar datos</button>
        </div>
      </form>

      <!-- Acciones disponibles -->
      <div class="acciones-alumno" id="acciones-alumno" style="display: none;">
        <h3>Acciones disponibles para el alumno</h3>
        <ul>
          <li><a id="link-modificar" href="#">Modificar datos</a></li>
          <li><a id="link-proyecto" href="#">Asignar/Cambiar proyecto</a></li>
          <li><a id="link-horario" href="#">Asignar/Cambiar horario</a></li>
          <li><a id="link-comentarios" href="#">Ver comentarios</a></li>
          <li><a id="link-log" href="#">Ver log</a></li>
          <li><a id="link-eliminar" href="#">Eliminar alumno</a></li>
        </ul>
      </div>
    </div>
  </main>
</div>

<!-- Script funcional -->
<script>
function toggleSubmenu(id) {
  const submenu = document.getElementById(id);
  submenu.hidden = !submenu.hidden;
}

window.addEventListener('DOMContentLoaded', () => {
  const submenu = document.getElementById('submenu-alumnos');
  if (submenu) submenu.hidden = false;
});

let matriculaSeleccionada = null;

document.getElementById('matricula').addEventListener('change', async function () {
  const matricula = this.value;
  matriculaSeleccionada = matricula;
  document.getElementById('acciones-alumno').style.display = 'none';

  if (!matricula) return;

  try {
    const res = await fetch(`/api/alumnos/datos?matricula=${encodeURIComponent(matricula)}`);
    const datos = await res.json();

    if (datos) {
      document.getElementById('nombre').value = datos.nombre || '';
      document.getElementById('apellido_paterno').value = datos.apellido_paterno || '';
      document.getElementById('apellido_materno').value = datos.apellido_materno || '';
      document.getElementById('telefono').value = datos.telefono || '';
      document.getElementById('email').value = datos.e_mail || '';
      document.getElementById('estado').value = datos.status || '';
      document.getElementById('documentacion').value = datos.documentos || '';
      document.getElementById('proyecto').value = datos.proyecto || '';
      document.getElementById('institucion').value = datos.institucion || '';
      document.getElementById('area').value = datos.area || '';
      document.getElementById('tipo_servicio').value = datos.tipo_servicio || '';
    }
  } catch (error) {
    console.error('Error al obtener datos del alumno:', error);
  }
});

document.getElementById('editar').addEventListener('click', function () {
  if (!matriculaSeleccionada) return;

  document.getElementById('acciones-alumno').style.display = 'block';

  document.getElementById('link-modificar').href = `/alumnos/modificar?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-proyecto').href = `/alumnos/asignar_proyecto?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-horario').href = `/alumnos/asignar_horario?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-comentarios').href = `/alumnos/comentarios?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-log').href = `/alumnos/log?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-eliminar').href = `/alumnos/eliminar?matricula=${matriculaSeleccionada}`;
});
</script>
{% endblock %}