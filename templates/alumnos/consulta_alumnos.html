{% extends "layout/base.html" %}

{% block contenido %}
<style>
  .busqueda-container {
    margin-bottom: 1rem;
  }
  #resultados {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
  }
  #resultados li {
    padding: 0.5rem;
    cursor: pointer;
    border-bottom: 1px solid #eee;
  }
  #resultados li:hover {
    background-color: #f0f0f0;
  }
  .form-actions {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
  }
  .btn-regresar {
    background-color: #555;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
  }
  .btn-regresar:hover {
    background-color: #333;
  }
  .acciones-alumno ul {
    list-style: none;
    padding: 0;
  }
  .acciones-alumno li {
    margin: 0.5rem 0;
  }
  .acciones-alumno a {
    text-decoration: none;
    color: #007bff;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .acciones-alumno a:hover {
    color: #0056b3;
  }
</style>

<div class="dashboard-wrapper">
  <!-- Men√∫ lateral institucional completo -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <!-- Alumnos -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-alumnos')">Alumnos</a>
        <ul class="submenu" id="submenu-alumnos" hidden>
          <li><a href="/alumnos/registrar">Registrar nuevo alumno</a></li>
          <li><a href="/alumnos/activar">Activar/Inactivar alumno</a></li>
          <li><a href="/alumnos/modificar">Modificar datos del alumno</a></li>
          <li><a href="/alumnos/asignar_proyecto">Asignar/Cambiar proyecto al alumno</a></li>
          <li><a href="/alumnos/desasignar_proyecto">Desasignar proyecto al alumno</a></li>
          <li><a href="/alumnos/modificar_contrasena">Cambiar contrase√±a al alumno</a></li>
          <li><a href="/alumnos/asignar_horario">Asignar/Cambiar horario al alumno</a></li>
          <li><a href="/alumnos/horario">Horario alumno</a></li>
          <li><a href="/alumnos/comentarios">Hist√≥rico de comentarios del alumno</a></li>
          <li><a href="/alumnos/log">Log del alumno</a></li>
          <li><a href="/alumnos/eliminar">Eliminar alumno</a></li>
          <li><a href="/alumnos/consulta" class="activo">Consulta de alumnos</a></li>
        </ul>
      </li>

      <!-- Instituciones -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-instituciones')">Instituciones</a>
        <ul class="submenu" id="submenu-instituciones" hidden>
          <li><a href="/instituciones/registrar">Registrar nueva instituci√≥n</a></li>
          <li><a href="/instituciones/modificar">Modificar instituci√≥n</a></li>
          <li><a href="/instituciones/eliminar">Eliminar instituci√≥n</a></li>
          <li><a href="/instituciones/consulta">Consultar instituciones</a></li>
        </ul>
      </li>

      <!-- Proyectos -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-proyectos')">Proyectos</a>
        <ul class="submenu" id="submenu-proyectos" hidden>
          <li><a href="/proyectos/registrar">Registrar nuevo proyecto</a></li>
          <li><a href="/proyectos/modificar">Modificar datos del proyecto</a></li>
          <li><a href="/proyectos/terminar">Terminar proyecto</a></li>
          <li><a href="/proyectos/consulta">Consulta de proyectos</a></li>
        </ul>
      </li>

      <!-- Asistencia -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-asistencia')">Asistencia</a>
        <ul class="submenu" id="submenu-asistencia" hidden>
          <li><a href="/asistencia/consulta">Consultar asistencia del alumno</a></li>
          <li><a href="/asistencia/incidencias">Incidencias</a></li>
        </ul>
      </li>

      <!-- Documentos -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-documentos')">Documentos</a>
        <ul class="submenu" id="submenu-documentos" hidden>
          <li><a href="/documentos/aceptacion">Carta de aceptaci√≥n</a></li>
          <li><a href="/documentos/terminacion">Carta de terminaci√≥n</a></li>
          <li><a href="/documentos/horas">Constancia de horas</a></li>
        </ul>
      </li>

      <!-- Perfil -->
      <li>
        <a href="#" class="menu-principal" onclick="toggleSubmenu('submenu-perfil')">Perfil</a>
        <ul class="submenu" id="submenu-perfil" hidden>
          <li><a href="/perfil/modificar">Modificar perfil</a></li>
          <li><a href="/dashboard/login.html">Cerrar sesi√≥n</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- √Årea principal -->
  <main class="dashboard-main">
    <div class="dashboard-body">
      <h2>Consulta de alumnos</h2>

      <!-- Buscador din√°mico -->
      <div class="busqueda-container">
        <label for="busqueda">Buscar por nombre:</label>
        <input type="text" id="busqueda" placeholder="Escribe un nombre...">
        <ul id="resultados"></ul>
      </div>

      <!-- Datos del alumno -->
      <fieldset class="datos-alumno">
        <legend>Datos del alumno</legend>
        <label>Nombre:</label>
        <input type="text" id="nombre" readonly>
        <label>Apellido paterno:</label>
        <input type="text" id="apellido_paterno" readonly>
        <label>Apellido materno:</label>
        <input type="text" id="apellido_materno" readonly>
        <label>Tel√©fono:</label>
        <input type="text" id="telefono" readonly>
        <label>Correo:</label>
        <input type="email" id="email" readonly>
      </fieldset>

      <div class="form-actions">
        <button type="button" id="editar">Editar datos</button>
        <a href="/dashboard" class="btn-regresar">Regresar </a>
      </div>

      <!-- Acciones disponibles -->
      <div class="acciones-alumno" id="acciones-alumno" style="display: none;">
        <h3>Acciones disponibles</h3>
        <ul>
          <li><a id="link-modificar" href="#"><span>‚úèÔ∏è</span> Modificar datos</a></li>
          <li><a id="link-proyecto" href="#"><span>üìÇ</span> Asignar/Cambiar proyecto</a></li>
          <li><a id="link-horario" href="#"><span>üìÖ</span> Asignar/Cambiar horario</a></li>
          <li><a id="link-comentarios" href="#"><span>üí¨</span> Ver comentarios</a></li>
          <li><a id="link-log" href="#"><span>üìú</span> Ver log</a></li>
          <li><a id="link-eliminar" href="#"><span>üóëÔ∏è</span> Eliminar alumno</a></li>
        </ul>
      </div>
    </div>
  </main>
</div>

<script>
function toggleSubmenu(id) {
  const submenu = document.getElementById(id);
  submenu.hidden = !submenu.hidden;
}
window.addEventListener('DOMContentLoaded', () => {
  const submenu = document.getElementById('submenu-alumnos');
  if (submenu) submenu.hidden = false;
});

let matriculaSeleccionada = null;

document.getElementById('busqueda').addEventListener('input', async function () {
  const nombre = this.value.trim();
  const resultados = document.getElementById('resultados');
  resultados.innerHTML = '';

  if (nombre.length < 2) return;

  try {
    const res = await fetch(`/api/alumnos/buscar?nombre=${encodeURIComponent(nombre)}`);
    const alumnos = await res.json();

    if (alumnos.length === 0) {
      resultados.innerHTML = '<li>No se encontraron coincidencias</li>';
      return;
    }

    alumnos.forEach(a => {
      const li = document.createElement('li');
      li.textContent = `${a.nombre} ${a.apellido_paterno} ${a.apellido_materno} (${a.matricula})`;
      li.addEventListener('click', () => cargarDatosAlumno(a.matricula));
      resultados.appendChild(li);
    });
  } catch (error) {
    console.error('Error al buscar alumnos:', error);
  }
});

// Cargar datos del alumno seleccionado
async function cargarDatosAlumno(matricula) {
  matriculaSeleccionada = matricula;
  document.getElementById('acciones-alumno').style.display = 'none';

  try {
    const res = await fetch(`/api/alumnos/datos?matricula=${encodeURIComponent(matricula)}`);
    const datos = await res.json();

    if (datos) {
      document.getElementById('nombre').value = datos.nombre || '';
      document.getElementById('apellido_paterno').value = datos.apellido_paterno || '';
      document.getElementById('apellido_materno').value = datos.apellido_materno || '';
      document.getElementById('telefono').value = datos.telefono || '';
      document.getElementById('email').value = datos.e_mail || '';
    }
  } catch (error) {
    console.error('Error al cargar datos del alumno:', error);
  }
}

// Mostrar acciones con enlaces din√°micos
document.getElementById('editar').addEventListener('click', function () {
  if (!matriculaSeleccionada) return;
  document.getElementById('acciones-alumno').style.display = 'block';

  document.getElementById('link-modificar').href = `/alumnos/modificar?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-proyecto').href = `/alumnos/asignar_proyecto?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-horario').href = `/alumnos/asignar_horario?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-comentarios').href = `/alumnos/comentarios?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-log').href = `/alumnos/log?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-eliminar').href = `/alumnos/eliminar?matricula=${matriculaSeleccionada}`;
});
</script>
{% endblock %}