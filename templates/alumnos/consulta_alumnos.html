{% extends "layout/base.html" %}

{% block titulo %}Consulta de alumnos{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/consulta_alumnos.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/consulta_alumnos_extra.css') }}">

<main class="dashboard-main">
  <div class="dashboard-body">
    <h2>Consulta de alumnos</h2>

    <div class="busqueda-container">
      <label for="busqueda">Buscar por nombre:</label>
      <input type="text" id="busqueda" placeholder="Escribe un nombre..." title="Buscar por nombre">
      <ul id="resultados"></ul>
    </div>

    <fieldset class="datos-alumno">
      <legend>Datos del alumno</legend>
      <label for="nombre" id="label-nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" readonly placeholder="Nombre del alumno" title="Nombre del alumno" aria-labelledby="label-nombre">

      <label for="apellido_paterno" id="label-apellido-paterno">Apellido paterno:</label>
      <input type="text" id="apellido_paterno" name="apellido_paterno" readonly placeholder="Apellido paterno" title="Apellido paterno" aria-labelledby="label-apellido-paterno">

      <label for="apellido_materno" id="label-apellido-materno">Apellido materno:</label>
      <input type="text" id="apellido_materno" name="apellido_materno" readonly placeholder="Apellido materno" title="Apellido materno" aria-labelledby="label-apellido-materno">

      <label for="telefono" id="label-telefono">Tel√©fono:</label>
      <input type="text" id="telefono" name="telefono" readonly placeholder="Tel√©fono" title="Tel√©fono" aria-labelledby="label-telefono">

      <label for="email" id="label-email">Correo:</label>
      <input type="email" id="email" name="email" readonly placeholder="Correo electr√≥nico" title="Correo electr√≥nico" aria-labelledby="label-email">
    </fieldset>

    <div class="form-actions">
      <button type="button" id="editar">Editar datos</button>
      <a href="/dashboard" class="btn-regresar">Regresar</a>
    </div>

    <div class="acciones-alumno oculto" id="acciones-alumno">
      <h3>Acciones disponibles</h3>
      <ul>
        <li><a id="link-modificar" href="#"><span>‚úèÔ∏è</span> Modificar datos</a></li>
        <li><a id="link-proyecto" href="#"><span>üìÇ</span> Asignar/Cambiar proyecto</a></li>
        <li><a id="link-horario" href="#"><span>üìÖ</span> Asignar/Cambiar horario</a></li>
        <li><a id="link-comentarios" href="#"><span>üí¨</span> Ver comentarios</a></li>
        <li><a id="link-log" href="#"><span>üìú</span> Ver log</a></li>
        <li><a id="link-eliminar" href="#"><span>üóëÔ∏è</span> Eliminar alumno</a></li>
      </ul>
    </div>
  </div>
</main>

<script>
let matriculaSeleccionada = null;

document.getElementById('busqueda').addEventListener('input', async function () {
  const nombre = this.value.trim();
  const resultados = document.getElementById('resultados');
  resultados.innerHTML = '';

  if (nombre.length < 2) return;

  try {
    const res = await fetch(`/api/alumnos/buscar?nombre=${encodeURIComponent(nombre)}`);
    const alumnos = await res.json();

    if (alumnos.length === 0) {
      resultados.innerHTML = '<li>No se encontraron coincidencias</li>';
      return;
    }

    alumnos.forEach(a => {
      const li = document.createElement('li');
      li.textContent = `${a.nombre} ${a.apellido_paterno} ${a.apellido_materno} (${a.matricula})`;
      li.addEventListener('click', () => cargarDatosAlumno(a.matricula));
      resultados.appendChild(li);
    });
  } catch (error) {
    console.error('Error al buscar alumnos:', error);
  }
});

async function cargarDatosAlumno(matricula) {
  matriculaSeleccionada = matricula;
  document.getElementById('acciones-alumno').classList.add('oculto');
  document.getElementById('acciones-alumno').style.display = 'none';

  try {
    const res = await fetch(`/api/alumnos/datos?matricula=${encodeURIComponent(matricula)}`);
    const datos = await res.json();

    if (datos) {
      document.getElementById('nombre').value = datos.nombre || '';
      document.getElementById('apellido_paterno').value = datos.apellido_paterno || '';
      document.getElementById('apellido_materno').value = datos.apellido_materno || '';
      document.getElementById('telefono').value = datos.telefono || '';
      document.getElementById('email').value = datos.e_mail || '';
    }
  } catch (error) {
    console.error('Error al cargar datos del alumno:', error);
  }
}

document.getElementById('editar').addEventListener('click', function () {
  if (!matriculaSeleccionada) return;
  document.getElementById('acciones-alumno').classList.remove('oculto');

  document.getElementById('link-modificar').href = `/alumnos/modificar?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-proyecto').href = `/alumnos/asignar_proyecto?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-horario').href = `/alumnos/asignar_horario?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-comentarios').href = `/alumnos/comentarios?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-log').href = `/alumnos/log?matricula=${matriculaSeleccionada}`;
  document.getElementById('link-eliminar').href = `/alumnos/eliminar?matricula=${matriculaSeleccionada}`;
});
</script>
{% endblock %}