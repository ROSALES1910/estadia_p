{% extends "layout/base.html" %}

{% block titulo %}Cambiar contrase√±a al alumno{% endblock %}

{% block menu %}
  {% include "layout/menu_general.html" %}
{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/formularios.css') }}">

<main class="dashboard-main">

  <div class="dashboard-body">
    <h2>Cambiar contrase√±a al alumno</h2>

    {% if mensaje %}
      <div class="alerta-exito">{{ mensaje }}</div>
    {% endif %}
    {% if error %}
      <div class="alerta-error">{{ error }}</div>
    {% endif %}

    <form method="post" action="/alumnos/modificar-contrasena" class="formulario" id="form-contrasena">
      <fieldset>
        <legend>Seleccionar alumno</legend>
        <label for="alumno">Alumno:</label>
        <select name="alumno" id="alumno" required>
          <option value="">Selecciona un alumno</option>
          {% for alumno in alumnos %}
            <option value="{{ alumno.matricula }}">{{ alumno.nombre }}</option>
          {% endfor %}
        </select>
      </fieldset>

      <input type="hidden" name="contrasena" id="contrasena">

      <div class="form-actions">
        <button type="button" class="btn btn-primary" id="btn-cambiar">Cambiar contrase√±a</button>
        <a href="/dashboard" class="btn-regresar">Regresar</a>
      </div>
    </form>
  </div>
</main>

<!-- MODAL CONFIRMACI√ìN -->
<div id="modalConfirmacion" class="modal oculto">
  <div class="modal-contenido">
    <h3>¬øSeguro que quieres cambiar la contrase√±a?</h3>
    <p>Se generar√° una nueva contrase√±a aleatoria.</p>

    <div class="modal-botones">
      <button id="btn-confirmar" class="btn btn-primary">S√≠, cambiar</button>
      <button onclick="cerrarModalConfirmacion()" class="btn btn-regresar">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL FINAL -->
<div id="modalContrasenaFinal" class="modal oculto">
  <div class="modal-contenido">
    <h3>Contrase√±a modificada con √©xito</h3>

    <p>La nueva contrase√±a del alumno es:</p>
    <p id="textoContrasenaFinal" class="contrasena-final-text"></p>

    <div class="modal-botones">
      <button onclick="copiarContrasena()" class="btn btn-primary">üìã Copiar</button>
      <button onclick="cerrarModalFinal()" class="btn btn-regresar">Aceptar</button>
    </div>
  </div>
</div>

<script>
  function generarContrasena() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let pass = "";
    for (let i = 0; i < 4; i++) {
      pass += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return pass;
  }

  function cerrarModalConfirmacion() {
    document.getElementById("modalConfirmacion").classList.add("oculto");
  }

  function cerrarModalFinal() {
    document.getElementById("modalContrasenaFinal").classList.add("oculto");
    document.getElementById("form-contrasena").submit();
  }

  function copiarContrasena() {
    const texto = document.getElementById("textoContrasenaFinal").textContent;
    navigator.clipboard.writeText(texto).then(() => {
      const btn = document.querySelector("#modalContrasenaFinal .btn.btn-primary");
      btn.textContent = "‚úî Copiada";
      setTimeout(() => btn.textContent = "üìã Copiar", 1200);
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form-contrasena');
    const alumnoSelect = document.getElementById('alumno');
    const contrasenaInput = document.getElementById('contrasena');
    const btnCambiar = document.getElementById('btn-cambiar');
    const btnConfirmar = document.getElementById('btn-confirmar');

    form.addEventListener("submit", e => e.preventDefault());

    btnCambiar.addEventListener('click', () => {
      if (!alumnoSelect.value) {
        alert("Selecciona un alumno antes de continuar.");
        return;
      }
      document.getElementById("modalConfirmacion").classList.remove("oculto");
    });

    btnConfirmar.addEventListener('click', () => {
      cerrarModalConfirmacion();

      const nueva = generarContrasena();
      contrasenaInput.value = nueva;

      document.getElementById("textoContrasenaFinal").textContent = nueva;
      document.getElementById("modalContrasenaFinal").classList.remove("oculto");
    });
  });
</script>

{% endblock %}