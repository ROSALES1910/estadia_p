{% extends "layout/base.html" %}

{% block titulo %}Generar log del alumno{% endblock %}

{% block menu %}
  {% include "layout/menu_general.html" %}
{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/formularios.css') }}">

<main class="dashboard-main">
  <div class="dashboard-body">
    <h2>Generar log del alumno</h2>

    {% if mensaje %}
      <div class="alerta-exito">{{ mensaje }}</div>
    {% endif %}
    {% if error %}
      <div class="alerta-error">{{ error }}</div>
    {% endif %}

    <!-- SELECCIÓN DE ALUMNO -->
    <form method="GET" action="/alumnos/log" class="formulario formulario--compact">
      <fieldset>
        <legend>Buscar alumno</legend>

        <label for="id_alumno">Selecciona un alumno:</label>
        <select name="id_alumno" id="id_alumno" required onchange="this.form.submit()">
          <option value="">-- Selecciona --</option>

          {% for alumno in alumnos %}
            <option value="{{ alumno.id_alumno }}"
              {% if seleccionado and alumno.id_alumno == seleccionado.id_alumno %}
                selected
              {% endif %}
            >
              {{ alumno.nombre }} {{ alumno.apellido_paterno }} {{ alumno.apellido_materno }}
            </option>
          {% endfor %}
        </select>
      </fieldset>
    </form>

    {% if seleccionado %}

      <hr>
      <h3>Resumen del alumno</h3>

      <p><strong>Nombre:</strong> {{ seleccionado.nombre }} {{ seleccionado.apellido_paterno }} {{ seleccionado.apellido_materno }}</p>
      <p><strong>Matrícula:</strong> {{ seleccionado.matricula }}</p>
      <p><strong>Correo:</strong> {{ seleccionado.correo }}</p>
      <p><strong>Teléfono:</strong> {{ seleccionado.telefono }}</p>
      <p><strong>Estado:</strong> {{ seleccionado.estado }}</p>
      <p><strong>Activo:</strong> {{ seleccionado.activo }}</p>
      <p><strong>Fecha de registro:</strong> {{ seleccionado.fecha_registro }}</p>

      {% if seleccionado.proyecto %}
        <p><strong>Proyecto asignado:</strong> {{ seleccionado.proyecto }}</p>
      {% endif %}

      {% if seleccionado.institucion %}
        <p><strong>Institución:</strong> {{ seleccionado.institucion }}</p>
      {% endif %}

      {% if seleccionado.horario %}
        <h4>Horario</h4>
        <div class="lista-horario">
          {% for dia, horas in seleccionado.horario.items() %}
            <div class="horario-item">
              <strong>{{ dia|capitalize }}:</strong>
              {{ horas[0] or '' }}
              {% if horas[0] and horas[1] %} - {{ horas[1] }}{% elif horas[1] %}{{ horas[1] }}{% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if seleccionado.comentarios_historial %}
        <h4>Comentarios</h4>
        <div class="lista-comentarios">
          {% for c in seleccionado.comentarios_historial %}
            <div class="comentario-item">
              {% if c.fecha %}
                {{ c.fecha }}
              {% else %}
                sin fecha
              {% endif %}
              — {{ c.usuario|default('usuario') }}: {{ c.comentario }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

    {% endif %}

    {% if registros %}
      <hr>
      <h3>Historial de acciones</h3>

      <table class="tabla-resultados">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Acción</th>
            <th>Usuario</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            <tr>
              <td>
                {% if r.fecha %}
                  {{ r.fecha }}
                {% else %}
                  sin fecha
                {% endif %}
              </td>
              <td>{{ r.accion }}</td>
              <td>{{ r.usuario }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    <div class="form-actions">
      <a href="/dashboard" class="btn-regresar">Regresar</a>
    </div>

  </div>
</main>
{% endblock %}