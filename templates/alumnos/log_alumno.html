{% extends "layout/base.html" %}

{% block titulo %}Generar log del alumno{% endblock %}

{% block menu %}
  {% include "layout/menu_general.html" %}
{% endblock %}

{% block contenido %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/formularios.css') }}">

<main class="dashboard-main">
  <div class="dashboard-body">
    <h2>Generar log del alumno</h2>

    {% if mensaje %}
      <div class="alerta-exito">{{ mensaje }}</div>
    {% endif %}
    {% if error %}
      <div class="alerta-error">{{ error }}</div>
    {% endif %}

    <form method="POST" action="/alumnos/log" class="formulario">
      <fieldset>
        <legend>Buscar alumno</legend>
        <label for="alumno">Selecciona un alumno:</label>
        <select name="alumno" id="alumno" required>
          <option value="">-- Selecciona --</option>
          {% for alumno in alumnos %}
            <option value="{{ alumno.matricula }}">{{ alumno.nombre }}</option>
          {% endfor %}
        </select>
      </fieldset>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Generar log</button>
        <a href="/dashboard" class="btn-regresar">Regresar</a>
      </div>
    </form>

    {% if resumen.datos %}
      <hr>
      <h3>Resumen del alumno</h3>
      <p><strong>Nombre:</strong> {{ resumen.datos.nombre }} {{ resumen.datos.apellido_paterno }} {{ resumen.datos.apellido_materno }}</p>
      <p><strong>Matrícula:</strong> {{ resumen.datos.matricula }}</p>
      <p><strong>Correo:</strong> {{ resumen.datos.correo }}</p>
      <p><strong>Teléfono:</strong> {{ resumen.datos.telefono }}</p>
      <p><strong>Estado:</strong> {{ resumen.datos.estado }}</p>
      <p><strong>Activo:</strong> {{ resumen.datos.activo }}</p>
      <p><strong>Fecha de registro:</strong> {{ resumen.datos.fecha_registro }}</p>

      {% if resumen.proyecto %}
        <p><strong>Proyecto asignado:</strong> {{ resumen.proyecto }}</p>
      {% endif %}
      {% if resumen.institucion %}
        <p><strong>Institución:</strong> {{ resumen.institucion }}</p>
      {% endif %}

      {% if resumen.horario %}
        <h4>Horario</h4>
        <ul>
          {% for dia, horas in resumen.horario.items() %}
          <li>{{ dia|capitalize }}: {{ horas[0] or '' }}{% if horas[0] and horas[1] %} - {{ horas[1] }}{% elif horas[1] %}{{ horas[1] }}{% endif %}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if resumen.comentarios %}
        <h4>Comentarios</h4>
        <ul>
          {% for c in resumen.comentarios %}
          <li>
            {%- set fecha = c.fecha if c.fecha is defined else None -%}
            {%- if fecha -%}
            {{ fecha.strftime('%d/%m/%Y') }}
            {%- else -%}
            sin fecha
            {%- endif -%}
             — {{ c.usuario|default('usuario') }}: {{ c.comentario }}
          </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endif %}

    {% if registros %}
      <hr>
      <h3>Historial de acciones</h3>
      <table class="tabla-resultados">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Acción</th>
            <th>Usuario</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            <tr>
              <td>
                {%- if r.fecha %}{{ r.fecha.strftime('%d/%m/%Y %H:%M') }}{% else %}sin fecha{% endif -%}
              </td>
              <td>{{ r.accion }}</td>
              <td>{{ r.usuario }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</main>
{% endblock %}
